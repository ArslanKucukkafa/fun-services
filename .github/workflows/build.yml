name: Build Microservices

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

jobs:
  detect-changes:
    name: Detect Service Changes
    runs-on: ubuntu-latest
    outputs:
      config: ${{ steps.check.outputs.config }}
      gateway: ${{ steps.check.outputs.gateway }}
      eureka: ${{ steps.check.outputs.eureka }}
      auth: ${{ steps.check.outputs.auth }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Detect changed folders
        id: check
        run: |
          git fetch origin ${{ github.event.before }}

          echo "BEFORE: ${{ github.event.before }}"
          echo "AFTER: ${{ github.sha }}"

          CONFIG_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^fun-config-service/' | wc -l)
          GATEWAY_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^fun-gateway-service/' | wc -l)
          EUREKA_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^fun-eureka-service/' | wc -l)
          AUTH_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^fun-auth-service/' | wc -l)
          
          echo "config=$CONFIG_CHANGED" >> $GITHUB_OUTPUT
          echo "gateway=$GATEWAY_CHANGED" >> $GITHUB_OUTPUT
          echo "eureka=$EUREKA_CHANGED" >> $GITHUB_OUTPUT
          echo "auth=$AUTH_CHANGED" >> $GITHUB_OUTPUT

  call-gateway-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.gateway != '0'
    uses: arslankucukkafa/fun-microservices/.github/workflows/fun-gateway-service.yml@git_actions

  call-eureka-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.eureka != '0'
    uses: arslankucukkafa/fun-microservices/.github/workflows/fun-eureka-service.yml@git_actions

  call-config-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.config != '0'
    uses: arslankucukkafa/fun-microservices/.github/workflows/fun-config-service.yml@git_actions

  call-auth-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.auth != '0'
    uses: arslankucukkafa/fun-microservices/.github/workflows/fun-auth-service.yml@git_actions