name: Build Microservices

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  detect-changes:
    name: Detect Service Changes
    runs-on: ubuntu-latest
    outputs:
      config: ${{ steps.check.outputs.config }}
      gateway: ${{ steps.check.outputs.gateway }}
      eureka: ${{ steps.check.outputs.eureka }}
      auth: ${{ steps.check.outputs.auth }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed folders
        id: check
        run: |
          # "before" commit'i geçerli değilse, tüm servisleri işaretle
          if [[ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]]; then
            echo "config=1" >> $GITHUB_OUTPUT
            echo "gateway=1" >> $GITHUB_OUTPUT
            echo "eureka=1" >> $GITHUB_OUTPUT
            echo "auth=1" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Değişiklikleri dinamik SHA'lar ile kontrol et
          CONFIG_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -c '^fun-config-service/')
          GATEWAY_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -c '^fun-gateway-service/')
          EUREKA_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -c '^fun-eureka-service/')
          AUTH_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -c '^fun-auth-service/')

          echo "config=$CONFIG_CHANGED" >> $GITHUB_OUTPUT
          echo "gateway=$GATEWAY_CHANGED" >> $GITHUB_OUTPUT
          echo "eureka=$EUREKA_CHANGED" >> $GITHUB_OUTPUT
          echo "auth=$AUTH_CHANGED" >> $GITHUB_OUTPUT

  call-gateway-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.gateway != '0'
    uses: ./.github/workflows/fun-gateway-service.yml

  call-eureka-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.eureka != '0'
    uses: ./.github/workflows/fun-eureka-service.yml

  call-config-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.config != '0'
    uses: ./.github/workflows/fun-config-service.yml

  call-auth-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.auth != '0'
    uses: ./.github/workflows/fun-auth-service.yml